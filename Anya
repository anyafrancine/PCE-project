<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f9;
        }

        .header-container {
            display: flex;
            align-items: center;
            background-color: #8B0000;
            padding: 20px 40px;
            color: white;
        }

        .logo {
            width: 200px;
            margin-right: 20px;
        }

        .text-container h1 {
            font-size: 100px;
            margin: 0;
        }

        .text-container h2 {
            font-size: 60px;
            margin: 5px 0;
        }

        table {
            width: 85%;
            margin: 0 auto;
            border-collapse: collapse;
            background: #ffffff;
            table-layout: fixed; /* Ensures consistent column layout */
            word-wrap: break-word;
        }

        th, td {
            padding: 15px;
            font-size: 40px;
            text-align: left;
            border: 2px solid #8B0000;
            text-align: center;
            vertical-align: top; /* Aligns long text to the top */
        }

        th {
            background-color: #8B0000;
            color: white;
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #ddd;
        }

        h3 {
            text-align: center;
            font-size: 60px;
            margin: 40px auto 0;
            background-color: #8B0000;
            padding: 20px 40px;
            color: white;
            width: 85%;
            box-sizing: border-box;
            border: 2px solid #f2f2f2;
        }

        hr {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <img src="https://scontent.fmnl8-1.fna.fbcdn.net/v/t39.30808-6/279800257_484698290119133_1493035390163788707_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeEN5D3IHhLGGVQpK1w4dln89Dc0gcH2VYr0NzSBwfZViqLQWGDZdFCQ0nfgeLRk_h74OMxg5TfPpntUltBzTq-i&_nc_ohc=Eg1BcmoPvjIQ7kNvgFqjdX8&_nc_zt=23&_nc_ht=scontent.fmnl8-1.fna&_nc_gid=ASN7breEqg_86J-2TFEBqVg&oh=00_AYC_M5SgFXCZflKQFCe_GrcQ8D_91TvV8HAb6WbBz_OLdw&oe=676882BA" alt="Logo" class="logo">
        <div class="text-container">
            <h1>Olanis Group of Companies, Inc.</h1>
            <h2>Feedback Report</h2>
        </div>
    </div>

    <hr style="margin: 0;">

    <?php
    $servername = "localhost";
    $username = "root";
    $password = "password";
    $dbname = "Olanis";

    $conn = new mysqli($servername, $username, $password, $dbname);

    if ($conn->connect_error) {
        die("Connection failed: " . $conn->connect_error);
    }

    $currentMonth = date('m');
    $currentYear = date('Y'); 

    // SQL query to fetch feedbacks for the current month
    $sql_feedback = "
        SELECT 
            b.branch_name,
            f.feedback_date,
            f.feedback_text,
            c.customer_name,
            f.rating
        FROM feedbackreports f
        INNER JOIN branches b ON f.branch_id = b.branch_id
        INNER JOIN customers c ON f.customer_id = c.customer_id
        WHERE MONTH(f.feedback_date) = $currentMonth AND YEAR(f.feedback_date) = $currentYear
        ORDER BY b.branch_name, f.feedback_date DESC;
    ";

    echo "<h2 style='text-align: center; font-size: 50px; margin: 0; color: #8B0000;'>Sales Report for " . date('F Y') . "</h2><hr style='margin: 0'>";

    $result = $conn->query($sql_feedback);
    $current_branch = null;
    $branch_ratings = [];
    $overall_ratings = 0;
    $total_feedbacks = 0;

    if ($result->num_rows > 0) {
        while ($row = $result->fetch_assoc()) {
            // Check for a new branch and display a header
            if ($current_branch !== $row['branch_name']) {
                if ($current_branch !== null) echo "</table>";
                echo "<h3>{$row['branch_name']}</h3>";
                echo "<table>
                        <tr>
                            <th>Feedback Date</th>
                            <th>Customer Name</th>
                            <th>Feedback</th>
                            <th>Rating</th>
                        </tr>";
                $current_branch = $row['branch_name'];
                $branch_ratings[$row['branch_name']] = ['total' => 0, 'count' => 0]; // Initialize for the new branch
            }

            // Display feedback details including rating
            echo "<tr>
                    <td>{$row['feedback_date']}</td>
                    <td>{$row['customer_name']}</td>
                    <td>{$row['feedback_text']}</td>
                    <td>{$row['rating']}</td>
                  </tr>";

            // Update branch ratings data
            $branch_ratings[$row['branch_name']]['total'] += $row['rating'];
            $branch_ratings[$row['branch_name']]['count']++;

            // Update overall ratings data
            $overall_ratings += $row['rating'];
            $total_feedbacks++;
        }
        echo "</table>";

        // Calculate and display the total ratings for each branch
        echo "<h3>Total Ratings for Each Branch</h3>";
        echo "<table>
                <tr>
                    <th>Branch Name</th>
                    <th>Average Rating</th>
                </tr>";
        foreach ($branch_ratings as $branch_name => $ratings) {
            $average_rating = $ratings['count'] > 0 ? round($ratings['total'] / $ratings['count'], 2) : 0;
            echo "<tr>
                    <td>{$branch_name}</td>
                    <td>{$average_rating}/5</td>
                  </tr>";
        }

        // Calculate the overall average rating
        if ($total_feedbacks > 0) {
            $overall_average = round($overall_ratings / $total_feedbacks, 2);
            echo "<tr>
                    <th><strong>Overall Average Rating</strong></th>
                    <th><strong>{$overall_average}/5</strong></th>
                  </tr>";
        }

        echo "</table>";
    } else {
        echo "<h3>No feedback available for " . date('F Y') . "</h3>";
    }

    $conn->close();
    ?>

</body>
</html>
